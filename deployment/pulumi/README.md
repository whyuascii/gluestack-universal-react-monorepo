# Infrastructure Deployment with Pulumi

Deploy your application to AWS using Pulumi Infrastructure-as-Code with Amplify (web), App Runner (API), and RDS (database).

## Architecture

```
┌─────────────┐
│  Route 53   │ (DNS - Optional)
└──────┬──────┘
       │
┌──────▼──────────┐
│   CloudFront    │ (CDN + WAF)
└──────┬──────────┘
       │
┌──────▼──────────┐         ┌─────────────┐         ┌──────────────┐
│  Amplify Host   │────────▶│  App Runner │────────▶│   Supabase   │
│  (Next.js)      │         │    (API)    │         │  PostgreSQL  │
└─────────────────┘         └─────────────┘         │   (Managed)  │
                                                     └──────────────┘
```

## Resources Created

### Compute

- **AWS Amplify**: Next.js web application with auto-deploy from GitHub
  - Platform: WEB_COMPUTE (Next.js SSR support)
  - Framework: Next.js - SSR
- **App Runner**: Fastify API with auto-scaling (1-2 GB RAM, 1 vCPU)
  - Dual-stack networking (IPv4 + IPv6 support)
  - Public internet egress (for Supabase connectivity)
  - Auto-deploy from ECR on image push
- **ECR Repository**: Stores API Docker images with lifecycle policies

### Database

- **Supabase**: Managed PostgreSQL database (configured externally)
  - Automatic backups
  - Connection pooling
  - Built-in Auth, Storage, and Real-time capabilities
  - Dashboard for database management
  - Row Level Security (RLS) support

### Security

- **WAF Web ACL**: CloudFront protection with AWS Managed Rules
- **Secrets Manager**: Supabase credentials and auth secrets
- **IAM Roles**: Least privilege for App Runner and ECR access

### Monitoring

- **CloudWatch Log Groups**: API logs with 30-day retention
- **CloudWatch Alarms**: API error rate monitoring

## Prerequisites

1. **AWS Account** with appropriate permissions
2. **Supabase Account** and project ([Sign up](https://supabase.com))
3. **Pulumi CLI** installed ([Install Guide](https://www.pulumi.com/docs/get-started/install/))
4. **Node.js 20+** and **pnpm** installed
5. **AWS CLI** configured with credentials
6. **Docker** installed (for building and pushing images)

## Quick Start (5 Minutes)

### 1. Run Setup Script

```bash
cd deployment/pulumi
./setup.sh
```

This interactive script will:

- Check prerequisites
- Configure Pulumi backend
- Create/select a stack
- Set all required configuration values (including Supabase credentials)
- Generate secure auth secrets

**Note**: You'll need Supabase credentials ready. Create a project at https://supabase.com/dashboard first.

### 2. Deploy Infrastructure

```bash
# Preview changes
pulumi preview

# Deploy (takes 10-15 minutes)
pulumi up
```

### 3. Build and Push API Docker Image

```bash
# Get outputs
API_REPO=$(pulumi stack output apiRepositoryUrl)
AWS_REGION=$(pulumi config get aws:region)

# Login to ECR
aws ecr get-login-password --region $AWS_REGION | \
  docker login --username AWS --password-stdin $API_REPO

# Build and push from project root
cd ../..
docker build -f apps/api/Dockerfile -t $API_REPO:latest .
docker push $API_REPO:latest
```

Alternatively, use the helper script:

```bash
cd deployment/pulumi
./push-api.sh
```

### 4. Run Database Migrations

```bash
# Get database URL from Secrets Manager
export DATABASE_URL=$(aws secretsmanager get-secret-value \
  --secret-id $(pulumi config get projectName || echo "app")/$(pulumi stack --show-name)/supabase/credentials \
  --query SecretString --output text | jq -r .databaseUrl)

# Run migrations
pnpm --filter database db:migrate

# Optional: Seed database
pnpm --filter database db:seed
```

**Alternative**: Use the Supabase connection string directly from your Pulumi config:

```bash
export DATABASE_URL=$(pulumi config get --show-secrets databaseUrl)
pnpm --filter database db:migrate
```

### 5. Deploy Web Application

```bash
# Push to GitHub - Amplify auto-deploys
git push origin main
```

### 6. Access Your Application

```bash
# Get URLs
pulumi stack output apiServiceUrl
pulumi stack output amplifyBranchUrl
```

## Configuration

### Required Configuration

All configuration is managed through Pulumi config:

```bash
# Supabase (create project first at https://supabase.com/dashboard)
pulumi config set supabaseUrl https://xxxxx.supabase.co
pulumi config set --secret databaseUrl "postgresql://postgres.[ref]:[PASSWORD]@db.xxxxx.supabase.com:5432/postgres"
pulumi config set --secret supabaseAnonKey "eyJxxx..."
pulumi config set --secret supabaseServiceRoleKey "eyJxxx..."

# Auth secret (auto-generated by setup.sh)
pulumi config set --secret betterAuthSecret "$(openssl rand -base64 32)"

# GitHub repository settings
pulumi config set githubOwner YOUR_GITHUB_USERNAME
pulumi config set githubRepo your-repo-name
pulumi config set githubBranch main

# AWS region
pulumi config set aws:region us-east-1
```

**Getting Supabase Credentials**:

1. Create project at https://supabase.com/dashboard
2. Go to Project Settings → API
3. Copy Project URL, anon key, and service_role key
4. Go to Project Settings → Database → Connection String
5. Copy the connection string (use "Connection Pooling" for production)

### Optional Configuration

```bash
# Project name (default: "app")
pulumi config set projectName myapp

# GitHub token (only needed for private repos)
pulumi config set --secret githubToken ghp_your_github_token

# Custom domain
pulumi config set domain yourdomain.com

# OAuth providers
pulumi config set --secret googleClientId your-google-client-id
pulumi config set --secret googleClientSecret your-google-client-secret
pulumi config set --secret githubClientId your-github-client-id
pulumi config set --secret githubClientSecret your-github-client-secret

# Analytics
pulumi config set --secret posthogKey your-posthog-key
pulumi config set posthogHost https://us.i.posthog.com
```

### View All Configuration

```bash
pulumi config
```

## Common Operations

### Update API

```bash
# Build and push new image (App Runner auto-deploys)
cd ../..
ECR_REPO=$(cd deployment/pulumi && pulumi stack output apiRepositoryUrl)
docker build -f apps/api/Dockerfile -t $ECR_REPO:latest .
docker push $ECR_REPO:latest

# Or use helper script
cd deployment/pulumi
./push-api.sh
```

### Update Web

```bash
# Just push to GitHub - Amplify auto-deploys
git push origin main
```

### Update Infrastructure

```bash
cd deployment/pulumi
pulumi up
```

### View Logs

```bash
# API logs
aws logs tail /aws/apprunner/$(pulumi config get projectName || echo "app")-api-$(pulumi stack --show-name) --follow

# Database logs
aws logs tail /aws/rds/instance/$(pulumi config get projectName || echo "app")-db-$(pulumi stack --show-name)/postgresql --follow
```

### Database Operations

```bash
# Get Supabase credentials
aws secretsmanager get-secret-value \
  --secret-id $(pulumi stack output supabaseSecretArn) \
  --query SecretString --output text | jq

# Open Drizzle Studio
export DATABASE_URL=$(pulumi config get --show-secrets databaseUrl)
pnpm --filter database db:studio

# Or use Supabase Dashboard
open https://supabase.com/dashboard/project/$(pulumi config get supabaseUrl | cut -d'/' -f3 | cut -d'.' -f1)
```

## Custom Domain Setup

### 1. Configure Domain

```bash
pulumi config set domain yourdomain.com
pulumi up
```

### 2. DNS Configuration

The deployment will output DNS records that need to be created. Run:

```bash
cd deployment/pulumi
./setup-dns.sh
```

This script will show you:

- Certificate validation CNAME records (add these first)
- Domain CNAME/ALIAS records (add these after validation)

### 3. Add DNS Records to Route 53

**For Root Domain (yourdomain.com)**:

```bash
# Get Amplify CloudFront distribution
AMPLIFY_DOMAIN=$(pulumi stack output amplifyBranchUrl | sed 's|https://||')

# Create ALIAS record in Route 53 (via console or CLI)
# Name: yourdomain.com
# Type: A (Alias)
# Target: ${AMPLIFY_DOMAIN}
```

**For WWW Subdomain**:

```bash
# Name: www.yourdomain.com
# Type: CNAME
# Value: ${AMPLIFY_DOMAIN}
```

**For API Subdomain**:

```bash
API_DOMAIN=$(pulumi stack output apiServiceUrl | sed 's|https://||')

# Name: api.yourdomain.com
# Type: CNAME
# Value: ${API_DOMAIN}
```

### 4. Verify DNS

```bash
# Check DNS propagation
dig yourdomain.com +short
dig www.yourdomain.com +short
dig api.yourdomain.com +short

# Test SSL certificates
curl -I https://yourdomain.com
curl -I https://api.yourdomain.com/health
```

**Note:** DNS propagation typically takes 5-60 minutes.

## Stack Management

### Multiple Environments

```bash
# Create and configure staging
pulumi stack init staging
pulumi config set aws:region us-east-1
pulumi config set projectName myapp
pulumi config set --secret dbPassword "$(openssl rand -base64 32)"
pulumi config set --secret betterAuthSecret "$(openssl rand -base64 32)"
pulumi up

# Create and configure production
pulumi stack init prod
pulumi config set aws:region us-east-1
pulumi config set projectName myapp
pulumi config set domain yourdomain.com
pulumi config set --secret dbPassword "$(openssl rand -base64 32)"
pulumi config set --secret betterAuthSecret "$(openssl rand -base64 32)"
pulumi up

# Switch between stacks
pulumi stack select dev
pulumi stack select staging
pulumi stack select prod
```

### List All Stacks

```bash
pulumi stack ls
```

## Cost Optimization

### Estimated Monthly Costs (Low Traffic)

- **Supabase Free Tier**: $0 (500MB database, 1GB file storage, 2GB bandwidth)
- **Supabase Pro** (optional): $25/month (8GB database, 100GB file storage, 250GB bandwidth)
- **App Runner**: ~$15-25 (with auto-scaling)
- **Amplify**: ~$5-10 (100GB served, few builds)
- **WAF**: ~$5-8
- **Data Transfer**: ~$5-10
- **CloudWatch**: ~$2-5
- **Total (Free Supabase)**: **~$32-58/month**
- **Total (Pro Supabase)**: **~$57-83/month**

**Note**: Supabase Free tier is generous for development and small projects. Upgrade to Pro only when needed.

### Cost Management

```bash
# Pause non-production App Runner services
aws apprunner pause-service --service-arn $(pulumi stack output apiServiceArn)

# Resume App Runner service
aws apprunner resume-service --service-arn $(pulumi stack output apiServiceArn)

# Supabase: Pause project (via dashboard for Free tier)
# Go to https://supabase.com/dashboard → Project Settings → General → Pause Project

# Set up billing alarms
aws cloudwatch put-metric-alarm \
  --alarm-name billing-alarm \
  --alarm-description "Alert when monthly cost exceeds $100" \
  --metric-name EstimatedCharges \
  --namespace AWS/Billing \
  --statistic Maximum \
  --period 21600 \
  --threshold 100 \
  --comparison-operator GreaterThanThreshold \
  --evaluation-periods 1 \
  --dimensions Name=Currency,Value=USD
```

## Troubleshooting

### App Runner Can't Connect to Supabase

Supabase is accessible over the internet, so connection issues are usually related to:

```bash
# Check if DATABASE_URL is correctly set in App Runner
aws apprunner describe-service \
  --service-arn $(pulumi stack output apiServiceArn) | \
  jq '.Service.SourceConfiguration.ImageRepository.ImageConfiguration.RuntimeEnvironmentSecrets'

# Verify Supabase connection string locally
export DATABASE_URL=$(pulumi config get --show-secrets databaseUrl)
psql $DATABASE_URL -c "SELECT version();"

# Check Supabase project status
# Go to https://supabase.com/dashboard and verify project is active
```

**Common Issues**:

- Database password in connection string is incorrect
- Supabase project is paused
- Connection pooling URL (port 6543) vs direct connection (port 5432)
- Network restrictions in Supabase project settings

### Amplify Build Fails

```bash
# Check build logs
aws amplify list-jobs \
  --app-id $(pulumi stack output amplifyAppId) \
  --branch-name main

# Get specific job details
aws amplify get-job \
  --app-id $(pulumi stack output amplifyAppId) \
  --branch-name main \
  --job-id <JOB_ID>
```

This script will help you either force-delete or restore and import existing secrets.

### Refresh Pulumi State

```bash
pulumi refresh
```

### Export/Import State

```bash
# Export state
pulumi stack export > state.json

# Import state
pulumi stack import < state.json
```

## Cleanup

### Destroy All Resources

```bash
# Preview what will be destroyed
pulumi destroy --preview

# Destroy stack
pulumi destroy
```

**Note:** This will NOT delete your Supabase project. If you want to delete it:

1. Go to https://supabase.com/dashboard
2. Select your project
3. Go to Settings → General → Delete Project

### Remove Stack

```bash
# After destroy completes
pulumi stack rm dev
```

## CI/CD Integration

Example GitHub Actions workflow:

```yaml
name: Deploy Infrastructure

on:
  push:
    branches: [main]
    paths:
      - "deployment/pulumi/**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: |
          cd deployment/pulumi
          pnpm install

      - name: Deploy Infrastructure
        run: |
          cd deployment/pulumi
          pulumi stack select ${{ github.ref_name }}
          pulumi up --yes
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
```

## Security Best Practices

### Implemented

- ✅ Secrets stored in AWS Secrets Manager
- ✅ Supabase manages database encryption and backups
- ✅ WAF with managed rule sets
- ✅ Rate limiting
- ✅ IAM roles with least privilege
- ✅ CloudWatch monitoring and alarms
- ✅ Row Level Security (RLS) available in Supabase
- ✅ Supabase automatic backups (daily on Pro tier)
- ✅ Dual-stack networking (IPv4 + IPv6) on App Runner
- ✅ Public endpoints with HTTPS encryption

### Recommended

**AWS**:

- Enable AWS GuardDuty for threat detection
- Set up AWS Config for compliance
- Enable MFA for AWS root account
- Use AWS Organizations for multi-account setup

**Supabase**:

- Enable Row Level Security (RLS) on all tables
- Use separate Supabase projects for dev/staging/prod
- Enable 2FA on Supabase account
- Set up IP restrictions in Supabase (Pro tier)
- Monitor database performance in Supabase dashboard
- Enable Point-in-Time Recovery (PITR) for production (Pro tier)

## Amplify Configuration for Next.js SSR

AWS Amplify requires specific configuration to properly support Next.js 15 with Server-Side Rendering (App Router):

### Required Settings

- **Platform**: `WEB_COMPUTE` (required for SSR)
- **Framework**: `Next.js - SSR` (on the branch)

### Automatic Configuration (New Deployments)

When deploying with Pulumi, these settings are automatically configured in `index.ts`.

### Manual Configuration (Existing Apps)

If you have an existing Amplify app that needs to be updated, use the configuration script:

```bash
cd deployment/pulumi

# Use Pulumi output for app ID (automatic)
./configure-amplify.sh

# Or specify app ID explicitly
AMPLIFY_APP_ID=<APP_ID> ./configure-amplify.sh

# Or with custom branch
AMPLIFY_APP_ID=<APP_ID> AMPLIFY_BRANCH=main ./configure-amplify.sh

# Or specify all parameters
AMPLIFY_APP_ID=<APP_ID> AWS_REGION=us-east-1 AMPLIFY_BRANCH=main ./configure-amplify.sh
```

The script will:

1. Update the app platform to `WEB_COMPUTE`
2. Update the branch framework to `Next.js - SSR`
3. Verify the configuration
4. Display next steps

### Verification

To verify your Amplify configuration manually:

```bash
# Check app platform
aws amplify get-app --app-id YOUR_APP_ID --region us-east-1 | jq -r '.app.platform'
# Should output: WEB_COMPUTE

# Check branch framework
aws amplify get-branch --app-id YOUR_APP_ID --branch-name main --region us-east-1 | jq -r '.branch.framework'
# Should output: Next.js - SSR
```

## Helper Scripts

- **`setup.sh`**: Interactive setup wizard for initial configuration
- **`push-api.sh`**: Build and push API Docker image to ECR
- **`setup-dns.sh`**: Display DNS configuration instructions
- **`configure-amplify.sh`**: Configure Amplify for Next.js SSR (platform and framework settings)

## Support

For issues specific to:

- **Pulumi**: [Pulumi Community Slack](https://slack.pulumi.com/)
- **AWS Services**: [AWS Support](https://console.aws.amazon.com/support/)

## Additional Resources

- [Pulumi AWS Documentation](https://www.pulumi.com/docs/clouds/aws/)
- [AWS App Runner Documentation](https://docs.aws.amazon.com/apprunner/)
- [AWS Amplify Hosting Documentation](https://docs.aws.amazon.com/amplify/)
- [AWS RDS Best Practices](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_BestPractices.html)
- [AWS WAF Documentation](https://docs.aws.amazon.com/waf/)
