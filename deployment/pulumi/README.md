# Infrastructure Deployment with Pulumi

Deploy your application to AWS using Pulumi Infrastructure-as-Code with Amplify (web), App Runner (API), and Supabase (database).

## Architecture

```
┌─────────────┐
│  Route 53   │ (DNS - Optional)
└──────┬──────┘
       │
┌──────▼──────────┐
│   CloudFront    │ (CDN + WAF)
└──────┬──────────┘
       │
┌──────▼──────────┐         ┌─────────────┐
│  Amplify Host   │────────▶│  App Runner │ (API)
│  (Next.js)      │         └──────┬──────┘
└─────────────────┘                │
                                   │ (VPC Connector)
                                   │
                          ┌────────▼────────┐
                          │  Supabase PostgreSQL │
                          │  (VPC Private)  │
                          └─────────────────┘
```

## Resources Created

### Compute

- **AWS Amplify**: Next.js web application with auto-deploy from GitHub
- **App Runner**: Fastify API with auto-scaling (1-2 GB RAM, 1 vCPU)
- **ECR Repository**: Stores API Docker images

### Database

- **Supabase PostgreSQL 16**: db.t4g.micro instance with 20GB storage
  - Encrypted at rest
  - 7-day automated backups
  - Performance Insights enabled
  - CloudWatch logs enabled

### Networking

- **VPC**: 10.0.0.0/16 with 2 availability zones
- **Public Subnets**: For VPC endpoints
- **Private Subnets**: For database
- **Security Groups**: Minimal access (DB only from VPC connector)
- **VPC Connector**: Allows App Runner to access Supabase

### Security

- **WAF Web ACL**: CloudFront protection with AWS Managed Rules
- **Secrets Manager**: Database credentials and auth secrets
- **IAM Roles**: Least privilege for App Runner and ECR access

### Monitoring

- **CloudWatch Log Groups**: API logs with 30-day retention
- **CloudWatch Alarms**: API errors, database CPU, and storage

## Prerequisites

1. **AWS Account** with appropriate permissions
2. **Pulumi CLI** installed ([Install Guide](https://www.pulumi.com/docs/get-started/install/))
3. **Node.js 20+** and **pnpm** installed
4. **AWS CLI** configured with credentials
5. **Docker** installed (for building and pushing images)

## Quick Start (5 Minutes)

### 1. Run Setup Script

```bash
cd deployment/pulumi
./setup.sh
```

This interactive script will:

- Check prerequisites
- Configure Pulumi backend
- Create/select a stack
- Set all required configuration values
- Generate secure passwords and secrets

### 2. Deploy Infrastructure

```bash
# Preview changes
pulumi preview

# Deploy (takes 10-15 minutes)
pulumi up
```

### 3. Build and Push API Docker Image

```bash
# Get outputs
API_REPO=$(pulumi stack output apiRepositoryUrl)
AWS_REGION=$(pulumi config get aws:region)

# Login to ECR
aws ecr get-login-password --region $AWS_REGION | \
  docker login --username AWS --password-stdin $API_REPO

# Build and push from project root
cd ../..
docker build -f apps/api/Dockerfile -t $API_REPO:latest .
docker push $API_REPO:latest
```

Alternatively, use the helper script:

```bash
cd deployment/pulumi
./push-api.sh
```

### 4. Run Database Migrations

```bash
# Get database URL from Secrets Manager
export DATABASE_URL=$(aws secretsmanager get-secret-value \
  --secret-id $(pulumi config get projectName || echo "app")/$(pulumi stack --show-name)/database/credentials \
  --query SecretString --output text | jq -r .url)

# Run migrations
pnpm --filter database db:migrate

# Optional: Seed database
pnpm --filter database db:seed
```

### 5. Deploy Web Application

```bash
# Push to GitHub - Amplify auto-deploys
git push origin main
```

### 6. Access Your Application

```bash
# Get URLs
pulumi stack output apiServiceUrl
pulumi stack output amplifyBranchUrl
```

## Configuration

### Required Configuration

All configuration is managed through Pulumi config:

```bash
# Required secrets (auto-generated by setup.sh)
pulumi config set --secret dbPassword "$(openssl rand -base64 32)"
pulumi config set --secret betterAuthSecret "$(openssl rand -base64 32)"

# GitHub repository settings
pulumi config set githubOwner YOUR_GITHUB_USERNAME
pulumi config set githubRepo your-repo-name
pulumi config set githubBranch main

# AWS region
pulumi config set aws:region us-east-1
```

### Optional Configuration

```bash
# Project name (default: "app")
pulumi config set projectName myapp

# GitHub token (only needed for private repos)
pulumi config set --secret githubToken ghp_your_github_token

# Custom domain
pulumi config set domain yourdomain.com

# OAuth providers
pulumi config set --secret googleClientId your-google-client-id
pulumi config set --secret googleClientSecret your-google-client-secret
pulumi config set --secret githubClientId your-github-client-id
pulumi config set --secret githubClientSecret your-github-client-secret

# Analytics
pulumi config set --secret posthogKey your-posthog-key
pulumi config set posthogHost https://us.i.posthog.com
```

### View All Configuration

```bash
pulumi config
```

## Common Operations

### Update API

```bash
# Build and push new image (App Runner auto-deploys)
cd ../..
ECR_REPO=$(cd deployment/pulumi && pulumi stack output apiRepositoryUrl)
docker build -f apps/api/Dockerfile -t $ECR_REPO:latest .
docker push $ECR_REPO:latest

# Or use helper script
cd deployment/pulumi
./push-api.sh
```

### Update Web

```bash
# Just push to GitHub - Amplify auto-deploys
git push origin main
```

### Update Infrastructure

```bash
cd deployment/pulumi
pulumi up
```

### View Logs

```bash
# API logs
aws logs tail /aws/apprunner/$(pulumi config get projectName || echo "app")-api-$(pulumi stack --show-name) --follow

# Database logs
aws logs tail /aws/rds/instance/$(pulumi config get projectName || echo "app")-db-$(pulumi stack --show-name)/postgresql --follow
```

### Database Operations

```bash
# Get connection string
aws secretsmanager get-secret-value \
  --secret-id $(pulumi stack output dbSecretArn) \
  --query SecretString --output text | jq

# Open Drizzle Studio
export DATABASE_URL=$(aws secretsmanager get-secret-value \
  --secret-id $(pulumi stack output dbSecretArn) \
  --query SecretString --output text | jq -r .url)
pnpm --filter database db:studio
```

## Custom Domain Setup

### 1. Configure Domain

```bash
pulumi config set domain yourdomain.com
pulumi up
```

### 2. DNS Configuration

The deployment will output DNS records that need to be created. Run:

```bash
cd deployment/pulumi
./setup-dns.sh
```

This script will show you:

- Certificate validation CNAME records (add these first)
- Domain CNAME/ALIAS records (add these after validation)

### 3. Add DNS Records to Route 53

**For Root Domain (yourdomain.com)**:

```bash
# Get Amplify CloudFront distribution
AMPLIFY_DOMAIN=$(pulumi stack output amplifyBranchUrl | sed 's|https://||')

# Create ALIAS record in Route 53 (via console or CLI)
# Name: yourdomain.com
# Type: A (Alias)
# Target: ${AMPLIFY_DOMAIN}
```

**For WWW Subdomain**:

```bash
# Name: www.yourdomain.com
# Type: CNAME
# Value: ${AMPLIFY_DOMAIN}
```

**For API Subdomain**:

```bash
API_DOMAIN=$(pulumi stack output apiServiceUrl | sed 's|https://||')

# Name: api.yourdomain.com
# Type: CNAME
# Value: ${API_DOMAIN}
```

### 4. Verify DNS

```bash
# Check DNS propagation
dig yourdomain.com +short
dig www.yourdomain.com +short
dig api.yourdomain.com +short

# Test SSL certificates
curl -I https://yourdomain.com
curl -I https://api.yourdomain.com/health
```

**Note:** DNS propagation typically takes 5-60 minutes.

## Stack Management

### Multiple Environments

```bash
# Create and configure staging
pulumi stack init staging
pulumi config set aws:region us-east-1
pulumi config set projectName myapp
pulumi config set --secret dbPassword "$(openssl rand -base64 32)"
pulumi config set --secret betterAuthSecret "$(openssl rand -base64 32)"
pulumi up

# Create and configure production
pulumi stack init prod
pulumi config set aws:region us-east-1
pulumi config set projectName myapp
pulumi config set domain yourdomain.com
pulumi config set --secret dbPassword "$(openssl rand -base64 32)"
pulumi config set --secret betterAuthSecret "$(openssl rand -base64 32)"
pulumi up

# Switch between stacks
pulumi stack select dev
pulumi stack select staging
pulumi stack select prod
```

### List All Stacks

```bash
pulumi stack ls
```

## Cost Optimization

### Estimated Monthly Costs (Low Traffic)

- **Supabase db.t4g.micro**: ~$15-18
- **App Runner**: ~$15-25 (with auto-scaling)
- **Amplify**: ~$5-10 (100GB served, few builds)
- **WAF**: ~$5-8
- **Data Transfer**: ~$5-10
- **CloudWatch**: ~$2-5
- **Total**: **~$47-76/month**

### Cost Management

```bash
# Pause non-production services
aws apprunner pause-service --service-arn $(pulumi stack output apiServiceArn)

# Stop Supabase instance (non-prod only)
aws rds stop-db-instance --db-instance-identifier $(pulumi config get projectName || echo "app")-db-$(pulumi stack --show-name)

# Start Supabase instance
aws rds start-db-instance --db-instance-identifier $(pulumi config get projectName || echo "app")-db-$(pulumi stack --show-name)

# Set up billing alarms
aws cloudwatch put-metric-alarm \
  --alarm-name billing-alarm \
  --alarm-description "Alert when monthly cost exceeds $100" \
  --metric-name EstimatedCharges \
  --namespace AWS/Billing \
  --statistic Maximum \
  --period 21600 \
  --threshold 100 \
  --comparison-operator GreaterThanThreshold \
  --evaluation-periods 1 \
  --dimensions Name=Currency,Value=USD
```

## Troubleshooting

### App Runner Can't Connect to Database

```bash
# Check VPC Connector
aws apprunner describe-vpc-connector \
  --vpc-connector-arn $(pulumi stack output -j | jq -r '.vpcConnectorArn')

# Check Security Groups
aws ec2 describe-security-groups \
  --filters "Name=tag:Name,Values=$(pulumi config get projectName || echo "app")-db-sg"
```

### Amplify Build Fails

```bash
# Check build logs
aws amplify list-jobs \
  --app-id $(pulumi stack output amplifyAppId) \
  --branch-name main

# Get specific job details
aws amplify get-job \
  --app-id $(pulumi stack output amplifyAppId) \
  --branch-name main \
  --job-id <JOB_ID>
```

This script will help you either force-delete or restore and import existing secrets.

### Refresh Pulumi State

```bash
pulumi refresh
```

### Export/Import State

```bash
# Export state
pulumi stack export > state.json

# Import state
pulumi stack import < state.json
```

## Cleanup

### Destroy All Resources

```bash
# Preview what will be destroyed
pulumi destroy --preview

# Destroy stack
pulumi destroy
```

**Note:** If deletion protection is enabled on Supabase, disable it first:

```bash
aws rds modify-db-instance \
  --db-instance-identifier $(pulumi config get projectName || echo "app")-db-$(pulumi stack --show-name) \
  --no-deletion-protection
```

### Remove Stack

```bash
# After destroy completes
pulumi stack rm dev
```

## CI/CD Integration

Example GitHub Actions workflow:

```yaml
name: Deploy Infrastructure

on:
  push:
    branches: [main]
    paths:
      - "deployment/pulumi/**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: |
          cd deployment/pulumi
          pnpm install

      - name: Deploy Infrastructure
        run: |
          cd deployment/pulumi
          pulumi stack select ${{ github.ref_name }}
          pulumi up --yes
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
```

## Security Best Practices

### Implemented

- ✅ Secrets stored in AWS Secrets Manager
- ✅ Database encrypted at rest
- ✅ VPC isolation for database
- ✅ WAF with managed rule sets
- ✅ Rate limiting
- ✅ Security groups with minimal access
- ✅ IAM roles with least privilege
- ✅ CloudWatch monitoring and alarms
- ✅ Performance Insights enabled
- ✅ Automated backups (7 days)

### Recommended

- Enable AWS GuardDuty for threat detection
- Set up AWS Config for compliance
- Enable VPC Flow Logs
- Use AWS Systems Manager Session Manager
- Implement AWS Backup for cross-region backups
- Enable MFA for AWS root account
- Use AWS Organizations for multi-account setup

## Helper Scripts

- **`setup.sh`**: Interactive setup wizard for initial configuration
- **`push-api.sh`**: Build and push API Docker image to ECR
- **`setup-dns.sh`**: Display DNS configuration instructions

## Support

For issues specific to:

- **Pulumi**: [Pulumi Community Slack](https://slack.pulumi.com/)
- **AWS Services**: [AWS Support](https://console.aws.amazon.com/support/)

## Additional Resources

- [Pulumi AWS Documentation](https://www.pulumi.com/docs/clouds/aws/)
- [AWS App Runner Documentation](https://docs.aws.amazon.com/apprunner/)
- [AWS Amplify Hosting Documentation](https://docs.aws.amazon.com/amplify/)
- [AWS Supabase Best Practices](https://docs.aws.amazon.com/AmazonSupabase/latest/UserGuide/CHAP_BestPractices.html)
- [AWS WAF Documentation](https://docs.aws.amazon.com/waf/)
